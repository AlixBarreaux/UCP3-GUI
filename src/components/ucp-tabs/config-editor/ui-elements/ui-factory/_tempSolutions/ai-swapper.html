<style>
    .ai-swapper {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100%;
        width: 100%;
    }


    .ai-swapper__overview {
        display: grid;
        grid-template-rows: repeat(2, 1fr);
        grid-template-columns: repeat(8, 1fr);
        height: 100%;
        width: 100%;
    }

    .ai-swapper__overview__ai {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .ai-swapper__change-menu {
        box-sizing: border-box;
        height: 100%;
        width: 100%;
    }

    .ai-swapper__change-menu__ai {
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        width: 100%;
    }

    .ai-swapper__change-menu__close {
        position: absolute;
        text-align: center;
        line-height: 16px;
        color: red;
        right: 0;
        top: 0;
        height: 20px;
        width: 20px;
        margin: 5px;
        padding: 0;
        border: black solid 2px;
    }

    .ai-swapper__change-menu__header {
        display: flex;
        justify-content: space-around;
        width: 100%;
    }

    .ai-swapper__change-menu__table {
        table-layout: fixed;
        margin-top: 15px;
        width: 100%;
        flex-grow: 1;
        border: black solid 1px;
        border-collapse: collapse;
    }

    .ai-swapper__change-menu__table th {
        border: black solid 1px;
        vertical-align: center;
        height: 1;
        padding: 2px 4px;

        white-space: nowrap;
        text-wrap: nowrap;
        overflow-x: hidden;
        text-overflow: ellipsis;
    }

    .ai-swapper__change-menu__table td {
        border-top: black dotted 1px;
        border-bottom: black dotted 1px;
        border-left: black solid 1px;
        border-right: black solid 1px;

        height: 1;
        vertical-align: top;

        word-break: break-all;
    }

    .ai-swapper__change-menu__table tr:last-child td {
        height: auto;
    }

    .ai-swapper__change-menu__table__header .small-column {
        width: min-content;
    }

    .ai-swapper__change-menu__table__row--current {
        border: black solid 1px;
        background-color: yellow;
        vertical-align: middle;
        text-align: center;
    }
</style>


<div class="ai-swapper">
    <dialog class="ai-swapper__change-menu">
        <button tabindex="0" class="ai-swapper__change-menu__close">
            &#10006;
        </button>
        <div class="ai-swapper__change-menu__ai">
            <h2 class="slot-name"></h2>
            <div class="ai-swapper__change-menu__header">
                <div>
                    <p class="current-name"></p>
                    <img class="ai-image" />
                </div>
                <div>
                    <button class="ai-swapper__change-menu__select">
                        SELECT
                    </button>
                </div>
            </div>
            <table class="ai-swapper__change-menu__table">
                <thead class="ai-swapper__change-menu__table__header">
                    <tr>
                        <th class="small-column index">INDEX</th>
                        <th class="name">NAME</th>
                        <th class="path">PATH</th>
                        <th class="language">LANGUAGE</th>
                        <th class="small-column binks">BINKS</th>
                        <th class="small-column speech">SPEECH</th>
                        <th class="small-column lines">LINES</th>
                        <th class="small-column portrait">PORTRAIT</th>
                        <th class="small-column aic">AIC</th>
                        <th class="small-column aiv">AIV</th>
                        <th class="small-column lord">LORD</th>
                        <th class="small-column start-troops">START_TROOPS</th>
                        <th class="priority">PRIORITY</th>
                        <th class="small-column remove">REMOVE</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="ai-swapper__change-menu__table__row--current">
                        <td>-</td>
                        <td>CURRENT</td>
                        <td>-</td>
                        <td>-</td>
                        <td>"index"</td>
                        <td>"index"</td>
                        <td>"index"</td>
                        <td>"index"</td>
                        <td>"index"</td>
                        <td>"index"</td>
                        <td>"index"</td>
                        <td>"index"</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>INDEX</td>
                        <td>NAME</td>
                        <td>PATH</td>
                        <td>LANGUAGE</td>
                        <td>BINKS</td>
                        <td>SPEECH</td>
                        <td>LINES</td>
                        <td>PORTRAIT</td>
                        <td>AIC</td>
                        <td>AIV</td>
                        <td>LORD</td>
                        <td>START_TROOPS</td>
                        <td>PRIORITY</td>
                        <td>REMOVE</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </dialog>

    <div class="ai-swapper__overview">
    </div>
</div>

<template class="template--ai-overview-slot">
    <div class="ai-swapper__overview__ai">
        <p class="slot-name"></p>
        <img class="ai-image" />
        <p class="ai-name">Test</p>
    </div>
</template>


<script>
    {
        const receiveBooleanOrFallback = function (bool, fallback = false) {
            return typeof bool === "boolean" ? bool : fallback;
        }

        const receiveStringOrFallback = function (str, fallback = "") {
            return typeof str === "string" ? str : fallback;
        }

        class AiControl {
            binks;
            speech;
            lines;
            portrait;
            aic;
            aiv;
            lord;
            startTroops;

            static fromControlObject(controlObj) {
                const aiControl = new AiControl();
                aiControl.binks = receiveBooleanOrFallback(controlObj.binks);
                aiControl.speech = receiveBooleanOrFallback(controlObj.speech);
                aiControl.lines = receiveBooleanOrFallback(controlObj.lines);
                aiControl.portrait = receiveBooleanOrFallback(controlObj.portrait);
                aiControl.aic = receiveBooleanOrFallback(controlObj.aic);
                aiControl.aiv = receiveBooleanOrFallback(controlObj.aiv);
                aiControl.lord = receiveBooleanOrFallback(controlObj.lord);
                aiControl.startTroops = receiveBooleanOrFallback(controlObj.startTroops);
                return aiControl;
            }

            clone() {
                const aiControl = new AiControl();
                aiControl.binks = this.binks;
                aiControl.speech = this.speech;
                aiControl.lines = this.lines;
                aiControl.portrait = this.portrait;
                aiControl.aic = this.aic;
                aiControl.aiv = this.aiv;
                aiControl.lord = this.lord;
                aiControl.startTroops = this.startTroops;
                return aiControl;
            }

            toControlObject() {
                return {
                    binks: this.binks,
                    speech: this.speech,
                    lines: this.lines,
                    portrait: this.portrait,
                    aic: this.aic,
                    aiv: this.aiv,
                    lord: this.lord,
                    startTroops: this.startTroops,
                };
            }
        }

        class AiMeta {
            name;
            description;
            author;
            link;
            version;
            defaultLang;
            supportedLang;
            possibleSettings;
            root;

            static fromMetaRootPath(path) {
                const metaPath = `${aiSetting.root}/meta.json`; // TODO
                // for paths
                // TODO: load meta file an verify

                const aiMeta = new AiMeta();
                aiMeta.name = receiveStringOrFallback(metaObj.name);
                aiMeta.description = receiveStringOrFallback(metaObj.description);
                aiMeta.author = receiveStringOrFallback(metaObj.author);
                aiMeta.link = receiveStringOrFallback(metaObj.link);
                aiMeta.version = receiveStringOrFallback(metaObj.version);
                aiMeta.defaultLang = receiveStringOrFallback(metaObj.defaultLang, null);
                aiMeta.supportedLang = Array.isArray(metaObj.supportedLang) ? metaObj.supportedLang : [];
                aiMeta.possibleSettings = new AiControl(metaObj.possibleSettings ?? {});

                // TODO
                aiMeta.root = metaPath;

                return aiMeta;
            }
        }

        class AiSetting {
            name;
            language;
            root;
            control;
            aiMeta;

            // if received from a present config
            static fromSettingObject(name, settingObj) {
                const aiSetting = new AiSetting();

                aiSetting.root = receiveStringOrFallback(settingObj.root);
                if (!aiSetting.root) {
                    return null; // does not exist
                }

                aiSetting.aiMeta = AiMeta.fromMetaPath(aiSetting.root);
                if (!aiSetting.aiMeta) {
                    return null; // does not exist
                }

                aiSetting.name = receiveStringOrFallback(name);
                aiSetting.language = receiveStringOrFallback(settingObj.language, null);
                aiSetting.control = new AiControl(settingObj.control ?? {});

                // updating state based on meta, in case invalid settings are present
                if (aiSetting.name !== aiSetting.aiMeta.name) {
                    aiSetting.name = aiSetting.aiMeta.name;
                }

                if (aiSetting.language !== null && !aiSetting.aiMeta.supportedLang.includes(aiSetting.language)) {
                    aiSetting.language = aiSetting.aiMeta.defaultLang;
                }

                return aiSetting;
            }

            static fromMeta(meta) {
                const aiSetting = new AiSetting();
                aiSetting.name = meta.name;
                aiSetting.root = meta.root;
                aiSetting.language = meta.defaultLang;
                aiSetting.control = meta.possibleSettings.clone();
                aiSetting.aiMeta = meta;
                return aiSetting;
            }

            toSettingNameAndObject() {
                const settingObj = {
                    language: this.language,
                    root: this.root,
                    control: this.control.toControlObject(),
                };
                return [this.name, settingObj];
            }
        }

        const AI_SLOTS = ["rat", "snake", "pig", "wolf", "saladin", "caliph", "sultan", "lionheart", "frederick", "phillip", "wazir", "emir", "nizar", "sheriff", "marshal", "abbot"];

        const AI_SETTINGS = new Map(AI_SLOTS.map((ai) => [ai, []]));

        const OVERVIEW = document.querySelector(".ai-swapper__overview");
        const CHANGE_MENU = document.querySelector(".ai-swapper__change-menu");

        // general init change menu
        CHANGE_MENU.querySelector(".ai-swapper__change-menu__close").addEventListener("click", () => CHANGE_MENU.close());

        const activateEditDialog = function (event) {
            const slotName = Array.from(event.currentTarget.classList).find((cssClass) => cssClass.startsWith("slot--")).replace("slot--", "").toUpperCase();

            CHANGE_MENU.querySelector(".slot-name").textContent = slotName;
            CHANGE_MENU.showModal();
        }

        const overviewTemp = document.querySelector(".template--ai-overview-slot");
        for (const ai of AI_SLOTS) {
            const clone = overviewTemp.content.cloneNode(true);
            const cloneDiv = clone.querySelector(".ai-swapper__overview__ai");
            cloneDiv.classList.add(`slot--${ai}`);
            clone.querySelector(".slot-name").textContent = ai.toUpperCase();
            // TODO: picture + current
            cloneDiv.addEventListener("click", activateEditDialog);

            OVERVIEW.appendChild(clone);
        }

        const createResultConfig = function () {
            const configState = {};
            for (const [ai, settings] of AI_SETTINGS) {
                if (!settings.length) {
                    continue;
                }

                configState[ai] = {
                    contents: {
                        value: {}
                    }
                }

                // currently only one ai for override
                // the aiSwapper lacks real override support currently anyway, since the original thought
                // during module creation were no overlaps in the "true" settings of the used ais
                const [name, setting] = settings[0].toSettingNameAndObject();
                configState[ai].contents.value[name] = setting;
            }
            return configState;
        }
    };
</script>